<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"
	layout:decorate="~{layout/default_layout}">

<head>
</head>

<body>

	<div layout:fragment="content">
		<div class="subpage_wrap section">
			<h2 class="page-title" th:text="#{common.musicalbum.information}"></h2>
			<div class="tabcontent_wrap">
				<div class="tabcontent_0">
					<input id="cropit-image-input" type="file" accept="image/*" class="cropit-image-input hidden" value="">
					<form id="update-album" action="#" th:action="@{${musicform.getUrl()}}" th:object="${musicform}" method="POST" class="form-music" enctype="multipart/form-data" role="form">
						<div class="inputbox_wrap">
							<!--
							<ul>
								<li class="mb20">
									<div id="form-group-albumType" class="form-group inputbox" th:classappend="${#fields.hasErrors('albumType')} ? 'has-error' : ''">
										<label class="input_title db" th:text="#{model.music.type}"></label>
										<select class="form-control selectpicker clear w100p" th:field="*{albumType}">
											<option th:each="albumTypeOption : ${albumTypeMap}" th:value="${albumTypeOption['key']}" th:text="${albumTypeOption['value']}"></option>
										</select>
										<p th:if="${#fields.hasErrors('albumType')}" th:id="error-albumType" class="help-block" th:errors="*{albumType}"></p>
									</div>
								</li>
								<li class="mb20">
									<div id="form-group-genre" class="form-group inputbox" th:classappend="${#fields.hasErrors('genre')} ? 'has-error' : ''">
										<label class="input_title db" th:text="#{model.music.genre}"></label>
										<select class="form-control selectpicker clear w100p" th:field="*{genre.id}">
											<option th:each="genreOption : ${genreMap}" th:value="${genreOption['key']}" th:text="${genreOption['value']}"></option>
										</select>
										<p th:if="${#fields.hasErrors('genre')}" th:id="error-genre" class="help-block" th:errors="*{genre}"></p>
									</div>
								</li>
								<li>
									<div id="form-group-subject" class="form-group inputbox" th:classappend="${#fields.hasErrors('subject')} ? 'has-error' : ''">
										<label class="input_title" th:text="#{model.music.subject}"></label>
										<input th:field="*{subject}" th:type="text" th:placeholder="#{model.music.subject.placeholder}" onkeypress="return event.keyCode != 13;" class="form-control" />
										<p th:if="${#fields.hasErrors('subject')}" th:id="error-subject" class="help-block" th:errors="*{subject}"></p>
									</div>
								</li>
								<li>
									<div id="form-group-imageFilename" class="form-group inputbox" th:classappend="${#fields.hasErrors('imageFilename')} ? 'has-error' : ''">
										<div class="input-file" id="imageFilename">
											<label class="input_title" th:text="#{model.music.cover_image}"></label>
											<input th:type="text" th:field="*{imageFilename}" th:placeholder="#{model.music.cover_image.placeholder}" class="form-control imgupload_input" onclick="$('.cropit-image-input').trigger('click');return false;" onkeypress="return event.keyCode != 13;" readonly/>
											<img th:src="@{/img/inputicon_img.png}" alt="" />
										</div>
										<p th:if="${#fields.hasErrors('imageFilename')}" th:id="error-thumbnail" class="help-block" th:errors="*{imageFilename}"></p>
									</div>
								</li>
							</ul>
							-->
							<ul>
								<li class="mb20" style="width: 100%">
									<div id="form-group-albumType" class="form-group inputbox fl w10p mr2p" th:classappend="${#fields.hasErrors('albumType')} ? 'has-error' : ''">
										<label class="input_title db" th:text="#{model.music.type}"></label>
										<select class="form-control selectpicker clear w100p" th:field="*{albumType}">
											<option th:each="albumTypeOption : ${albumTypeMap}" th:value="${albumTypeOption['key']}" th:text="${albumTypeOption['value']}"></option>
										</select>
										<p th:if="${#fields.hasErrors('albumType')}" th:id="error-albumType" class="help-block" th:errors="*{albumType}"></p>
									</div>
									<div id="form-group-genre" class="form-group inputbox fl w10p mr2p" th:classappend="${#fields.hasErrors('genre')} ? 'has-error' : ''">
										<label class="input_title db" th:text="#{model.music.genre}"></label>
										<select class="form-control selectpicker clear w100p" th:field="*{genre.id}">
											<option th:each="genreOption : ${genreMap}" th:value="${genreOption['key']}" th:text="${genreOption['value']}"></option>
										</select>
										<p th:if="${#fields.hasErrors('genre')}" th:id="error-genre" class="help-block" th:errors="*{genre}"></p>
									</div>
									<div id="form-group-subject" class="form-group inputbox fl w37p mr2p" th:classappend="${#fields.hasErrors('subject')} ? 'has-error' : ''">
										<label class="input_title" th:text="#{model.music.subject}"></label>
										<input th:field="*{subject}" th:type="text" th:placeholder="#{model.music.subject.placeholder}" onkeypress="return event.keyCode != 13;" class="form-control" />
										<p th:if="${#fields.hasErrors('subject')}" th:id="error-subject" class="help-block" th:errors="*{subject}"></p>
									</div>
									<div id="form-group-imageFilename" class="form-group inputbox fl w37p" th:classappend="${#fields.hasErrors('imageFilename')} ? 'has-error' : ''">
										<div class="input-file" id="imageFilename">
											<label class="input_title" th:text="#{model.music.cover_image}"></label>
											<input th:type="text" th:field="*{imageFilename}" th:placeholder="#{model.music.cover_image.placeholder}" class="form-control imgupload_input" onclick="$('.cropit-image-input').trigger('click');return false;" onkeypress="return event.keyCode != 13;" readonly/>
											<img th:src="@{/img/inputicon_img.png}" alt="" />
										</div>
										<p th:if="${#fields.hasErrors('imageFilename')}" th:id="error-thumbnail" class="help-block" th:errors="*{imageFilename}"></p>
									</div>
								</li>
							</ul>
						</div>
						<div class="inputbox">
							<label class="input_title" th:text="#{model.music.label.description}"></label>
							<textarea class="form-control masage_input" th:field="*{description}" th:placeholder="#{model.music.description.placeholder}" rows="3"></textarea>
						</div>
						
						<div class="membership_btn mt50">
							<div class="btn_centerwrap btn_centerwrap2">
								<button class="btn btn-custom btn-dark h50" type="button" onclick="UPMEditMusic.submitAction(); return false;"><span th:text="#{button.save}" th:remove="tag"></span></button>
								<button class="btn btn-custom2 h50" th:onclick="@{${'UPMusic.goto(&quot;' + musicform.getUrl() + '&quot;);return false;'}}"><span th:text="#{button.cancel}" th:remove="tag"></span></button>
							</div>
						</div>
					</form>
					
					<h2 th:text="#{model.track.list}" class="mt20"></h2>
					
					<div th:if="${tracks != null and tracks.size() gt 0}" class="musiclist_table mt20">
						<table id="album-edit-track-table">
							<tr>
								<th th:text="#{model.track.number}"></th>
								<th th:text="#{model.track.information}"></th>
								<th th:text="#{model.track.title.select}"></th>
								<th th:text="#{model.track.edit}"></th>
								<th th:text="#{button.delete}"></th>
							</tr>
							<tr th:each="track,iter : ${tracks}" th:id="${track.id}" class="just-list album-edit-tracks">
								<td scope="row"><span th:text="${iter.index + 1}" th:remove="tag"></span></td>
								<th>
									<i><img class="track-list-cover" th:src="@{${track.getCoverImageUrl()}}" alt="" width="60" height="60"/></i>
									<p><span th:text="${track.subject}" th:remove="tag"></span></p>
								</th>
								<td th:onclick="@{${'UPMEditMusic.titleTrack(' + track.id + ');'}}" class="title-track-set-td pointer">
									<span id="track-title" class="glyphicon" th:classappend="${track.titleTrack} ? 'glyphicon-star' : 'glyphicon-star-empty'">&nbsp;</span>
								</td>
								<td th:if="${track.isEditable()}" th:onclick="@{${'UPMusic.goto(&quot;/music/track/' + track.id + '/edit&quot;);'}}" class="pointer" th:text="#{button.modify}"></td>
								<td th:unless="${track.isEditable()}"></td>
								<td th:if="${track.isEditable()}" th:onclick="@{${'UPMEditMusic.deleteTrack(' + track.id + ');'}}" class="pointer">X</td>
								<td th:unless="${track.isEditable()}"></td>
							</tr>
						</table>
					</div>
					
				</div>
			</div>
		</div>
		
		<div th:replace="fragments/common/modal_crop_image"></div>
		
		<script type="text/javascript" th:inline="javascript">
			var albumId = /*[[ ${musicform.id} ]]*/;
			
			var UPMEditMusic = {
				_config : {
					loading : false
				},
				readURL: function(input) {
					UPMEditMusic._config.loading = false;
					if (input.files && input.files[0]) {
						var reader = new FileReader();
						reader.onload = function(e) {
							$('#imgupload_pop').modal('hide');
							UPMCropImageModal.showModal(e, 1/1, '');
						}
					    reader.readAsDataURL(input.files[0]);
					}
				},
				submitAction: function(e) {
					if (!e) var e = window.event;
				    e.cancelBubble = true;
				    if (e.stopPropagation) e.stopPropagation();
				    if (UPMEditMusic._config.loading) return;
					UPMEditMusic._config.loading = true;
					UPMusic.startLoading();
					$('#update-album ul li').each(function() {
						  $(this).children().removeClass("has-error");
						  if ($(this).children().children("p").length) $(this).children().children("p").remove();
					});
				    var form = document.getElementById('update-album');
				    var formData = new FormData(form);
				    if (UPMCropImageModal._config.imageBlob) formData.append('coverImageMultipart', UPMCropImageModal._config.imageBlob, $('input#imageFilename').val());
					UPMusic.ajaxPostFormData(UPMusic._config._api_album + "/" + albumId, headers, formData, UPMEditMusic.submitCallback);
				},
				submitCallback : function(message, object) {
					if (message == 'true') {
						window.location.href="/music/album/" + object;
					} else {
						UPMusic.log(object);
						var jsonArr = JSON.parse(object);
						for (var key in jsonArr) {
							if (jsonArr.hasOwnProperty(key)) {
								$('#form-group-' + jsonArr[key].field).addClass('has-error');
								var errInfo = '<p id="error-' + jsonArr[key].field + '" class="help-block">' + jsonArr[key].codes[jsonArr[key].codes.length - 1] + '</p>';
								$('#form-group-' + jsonArr[key].field).append(errInfo);
							}
						}
					}
					UPMEditMusic._config.loading = false;
					UPMusic.stopLoading();
				},
				titleTrack : function(trackId) {
					if (UPMEditMusic._config.loading) return;
					UPMEditMusic._config.loading = true;
					var params = {};
					UPMusic.ajaxPost(UPMusic._config._api_track + '/' + trackId + '/title', headers, params, UPMEditMusic.titleTrackCallback);
				},
				titleTrackCallback : function(msg, obj) {
					if (msg == 'true') {
						$('.title-track-set-td').each(function(value) {
							if ($(this).parents('tr').attr('id') == obj) {
								$(this).find("#track-title").removeClass('glyphicon-star-empty').addClass('glyphicon-star');
							} else if ($(this).find("#track-title").hasClass('glyphicon-star')) {
								$(this).find("#track-title").removeClass('glyphicon-star').addClass('glyphicon-star-empty');
							}
						});
					} else {
						UPMusic.alert(msg);
					}
					UPMEditMusic._config.loading = false;
				},
				deleteTrack : function(trackId) {
					UPMusic.log("deleteTrack : track list length is " + $('#album-edit-tracks tr').length);
					if (2 > $('#album-edit-track-table tr.album-edit-tracks').length) {
						UPMusic.confirm("유일한 수록곡입니다. 삭제 시 앨범도 함께 삭제됩니다.<br>정말 삭제하시겠습니까?", function() {
							UPMEditMusic.deleteFinalTrackConfirm(trackId);
						});
					} else {
						UPMusic.confirm("정말 삭제하시겠습니까?", function() {
							UPMEditMusic.deleteTrackConfirm(trackId);
						});
					}
				},
				deleteTrackConfirm: function(trackId) {
					if (UPMEditMusic._config.loading) return;
					UPMEditMusic._config.loading = true;
					var params = {ids : [trackId]};
		  			UPMusic.ajaxDeleteItems(UPMusic._config._api_track + '/delete_tracks', headers, params, UPMEditMusic.deleteTrackCallback);
				},
				deleteFinalTrackConfirm: function(trackId) {
					if (UPMEditMusic._config.loading) return;
					UPMEditMusic._config.loading = true;
					var params = {ids : [trackId]};
		  			UPMusic.ajaxDeleteItems(UPMusic._config._api_track + '/delete_tracks_with_album', headers, params, UPMEditMusic.deleteFinalTrackCallback);
				},
				deleteTrackCallback: function(msg, object) {
					if (msg == 'true') {
						$('tr#' + object).remove();
					} else {
						UPMusic.alert("삭제하지 못했습니다. 잠시 후 다시 시도하십시오.");
					}
					UPMEditMusic._config.loading = false;
				},
				deleteFinalTrackCallback: function(msg, object) {
					if (msg == 'true') {
						window.location = '/my_upm/upload';
					} else {
						UPMusic.alert("삭제하지 못했습니다. 잠시 후 다시 시도하십시오.");
					}
					UPMEditMusic._config.loading = false;
				}
			};
			
			$("#cropit-image-input").change(function() {
				if (UPMEditMusic._config.loading) return;
				UPMEditMusic._config.loading = true;
				UPMEditMusic.readURL(this);
			});
			$(document).ready(function(){
			    $('input#subject').keyup(function(){
			        if ($(this).val().length > 50) {
			            UPMusic.alert('50자를 넘을 수 없습니다');
			            $(this).val($(this).val().substr(0, 50));
			        }
			    });
			});
		</script>
	</div>

</body>
</html>